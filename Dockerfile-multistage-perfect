# å®Œç¾çš„å¤šé˜¶æ®µæ„å»ºDockerfile - æ·±åº¦è§£æç‰ˆ

# ==================== ç¬¬ä¸€é˜¶æ®µï¼šæ„å»ºé˜¶æ®µ ====================
FROM python:3.11-alpine AS builder

# è®¾ç½®æ„å»ºå‚æ•°
ARG TARGETPLATFORM
ARG BUILDPLATFORM  
ARG TARGETOS
ARG TARGETARCH

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /build

# æ˜¾ç¤ºæ„å»ºä¿¡æ¯
RUN echo "Building for $TARGETPLATFORM on $BUILDPLATFORM"

# ğŸ”‘ å…³é”®ç‚¹1: åˆ›å»ºä¸“ç”¨çš„PythonåŒ…å®‰è£…ç›®å½•
ENV PYTHONUSERBASE=/opt/python
ENV PATH=/opt/python/bin:$PATH

# å®‰è£…æ„å»ºä¾èµ–
RUN apk add --no-cache --virtual .build-deps \
    gcc \
    musl-dev \
    linux-headers \
    libffi-dev \
    openssl-dev

# å¤åˆ¶requirementsæ–‡ä»¶
COPY requirements.txt .

# ğŸ”‘ å…³é”®ç‚¹2: å®‰è£…åˆ°è‡ªå®šä¹‰ç›®å½•ï¼Œç¡®ä¿æƒé™æ­£ç¡®
RUN pip install --user --no-cache-dir --no-warn-script-location \
    --prefix=/opt/python \
    -r requirements.txt

# ğŸ”‘ å…³é”®ç‚¹3: éªŒè¯å®‰è£…ç»“æœ
RUN echo "=== æ„å»ºé˜¶æ®µéªŒè¯ ===" && \
    ls -la /opt/python/ && \
    ls -la /opt/python/lib/python3.11/site-packages/ | head -10 && \
    /opt/python/bin/python -c "import flask; print('âœ… Flask version:', flask.__version__)"

# ==================== ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œé˜¶æ®µ ====================
FROM python:3.11-alpine

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV FLASK_APP=app.py
ENV FLASK_ENV=production

# ğŸ”‘ å…³é”®ç‚¹4: è®¾ç½®Pythonè·¯å¾„æŒ‡å‘å¤åˆ¶çš„åŒ…ç›®å½•
ENV PYTHONUSERBASE=/opt/python
ENV PATH=/opt/python/bin:$PATH
ENV PYTHONPATH=/opt/python/lib/python3.11/site-packages:$PYTHONPATH

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apk add --no-cache curl

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# ğŸ”‘ å…³é”®ç‚¹5: ä»æ„å»ºé˜¶æ®µå¤åˆ¶PythonåŒ…åˆ°ç›¸åŒè·¯å¾„
COPY --from=builder /opt/python /opt/python

# ğŸ”‘ å…³é”®ç‚¹6: éªŒè¯å¤åˆ¶ç»“æœ
RUN echo "=== è¿è¡Œé˜¶æ®µéªŒè¯ ===" && \
    ls -la /opt/python/ && \
    ls -la /opt/python/lib/python3.11/site-packages/ | head -10 && \
    python -c "import sys; print('Python path:', sys.path)" && \
    python -c "import flask; print('âœ… Flask import successful, version:', flask.__version__)"

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY app.py .
COPY templates/ templates/
COPY static/ static/

# åˆ›å»ºå¿…è¦ç›®å½•
RUN mkdir -p logs config

# ğŸ”‘ å…³é”®ç‚¹7: åˆ›å»ºç”¨æˆ·ä½†ä¿æŒåŒ…ç›®å½•æƒé™
RUN adduser -D -s /bin/sh app && \
    chown -R app:app /app && \
    chown -R app:app /opt/python

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER app

# ğŸ”‘ å…³é”®ç‚¹8: æœ€ç»ˆéªŒè¯
RUN python -c "import flask; print('âœ… Final verification: Flask', flask.__version__)"

# æš´éœ²ç«¯å£
EXPOSE 5000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:5000/ || exit 1

# å¯åŠ¨å‘½ä»¤
CMD ["python", "app.py"]