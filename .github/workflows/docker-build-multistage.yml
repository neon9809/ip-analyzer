name: Docker Multistage Build and Push

# è§¦å‘æ¡ä»¶
on:
  # æ‰‹åŠ¨è§¦å‘ - å¢åŠ å¤šé˜¶æ®µæ„å»ºé€‰é¡¹
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬ç±»å‹'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - custom
      custom_version:
        description: 'è‡ªå®šä¹‰ç‰ˆæœ¬å· (ä»…å½“ç‰ˆæœ¬ç±»å‹ä¸ºcustomæ—¶)'
        required: false
        type: string
      multistage_strategy:
        description: 'å¤šé˜¶æ®µæ„å»ºç­–ç•¥'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto      # è‡ªåŠ¨é€‰æ‹©æœ€ä½³æ–¹æ¡ˆ
          - method1   # è‡ªå®šä¹‰Pythonç›®å½•
          - method2   # ç³»ç»Ÿçº§åŒ…å¤åˆ¶
          - test-both # æµ‹è¯•ä¸¤ç§æ–¹æ¡ˆ
      push_to_registry:
        description: 'æ¨é€åˆ°å®¹å™¨ä»“åº“'
        required: true
        default: true
        type: boolean
  
  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è‡ªåŠ¨æ„å»º
  push:
    branches: [ "main" ]
    paths:
      - 'app.py'
      - 'requirements.txt'
      - 'Dockerfile*'
      - 'templates/**'
      - 'static/**'
  
  # Pull Requestæ—¶æ„å»ºæµ‹è¯•
  pull_request:
    branches: [ "main" ]
    paths:
      - 'app.py'
      - 'requirements.txt' 
      - 'Dockerfile*'
      - 'templates/**'
      - 'static/**'

# ç¯å¢ƒå˜é‡
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # å¤šé˜¶æ®µæ„å»ºç­–ç•¥é€‰æ‹©å’Œæµ‹è¯•
  multistage-build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      packages: write
      id-token: write
      actions: read
      security-events: write
    
    outputs:
      image-digest: ${{ steps.final-build.outputs.digest }}
      image-version: ${{ steps.version.outputs.version }}
      best-strategy: ${{ steps.strategy-test.outputs.best_strategy }}
      final-size: ${{ steps.strategy-test.outputs.final_size }}
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # è®¾ç½®Docker Buildx
      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64
      
      # ç™»å½•åˆ°GitHub Container Registry
      - name: ğŸ”‘ Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      # è®¡ç®—ç‰ˆæœ¬å·
      - name: ğŸ“‹ Calculate version
        id: version
        run: |
          set -e
          
          if [ -f VERSION ]; then
            CURRENT_VERSION=$(cat VERSION)
          else
            CURRENT_VERSION="1.0.0"
          fi
          
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
          
          IFS='.' read -ra PARTS <<< "$CURRENT_VERSION"
          MAJOR=${PARTS[0]}
          MINOR=${PARTS[1]}
          PATCH=${PARTS[2]}
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION_TYPE="${{ github.event.inputs.version_type }}"
            CUSTOM_VERSION="${{ github.event.inputs.custom_version }}"
          elif [ "${{ github.event_name }}" = "push" ]; then
            VERSION_TYPE="patch"
          else
            VERSION_TYPE="dev"
          fi
          
          case $VERSION_TYPE in
            "major")
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
              ;;
            "minor")
              MINOR=$((MINOR + 1))
              PATCH=0
              NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
              ;;
            "patch")
              PATCH=$((PATCH + 1))
              NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
              ;;
            "custom")
              if [ -n "$CUSTOM_VERSION" ]; then
                NEW_VERSION="$CUSTOM_VERSION"
              else
                NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
              fi
              ;;
            "dev")
              SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
              NEW_VERSION="${CURRENT_VERSION}-dev.${SHORT_SHA}"
              ;;
          esac
          
          echo "æ–°ç‰ˆæœ¬: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "is_dev=$( [ "$VERSION_TYPE" = "dev" ] && echo "true" || echo "false" )" >> $GITHUB_OUTPUT
      
      # å¤šé˜¶æ®µæ„å»ºç­–ç•¥æµ‹è¯•
      - name: ğŸ§ª Multistage Build Strategy Test
        id: strategy-test
        run: |
          set -e
          
          STRATEGY="${{ github.event.inputs.multistage_strategy }}"
          if [ -z "$STRATEGY" ]; then
            STRATEGY="auto"
          fi
          
          echo "ğŸ”¬ å¤šé˜¶æ®µæ„å»ºç­–ç•¥: $STRATEGY"
          
          # ç¡®ä¿æµ‹è¯•æ–‡ä»¶å­˜åœ¨
          if [ ! -f "Dockerfile-multistage-perfect" ] || [ ! -f "Dockerfile-multistage-alt" ]; then
            echo "âŒ å¤šé˜¶æ®µæ„å»ºDockerfileæ–‡ä»¶ç¼ºå¤±"
            echo "best_strategy=single-stage" >> $GITHUB_OUTPUT
            echo "final_size=éœ€è¦å•é˜¶æ®µæ„å»º" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          SUCCESS_METHOD=""
          BEST_SIZE=""
          
          # æµ‹è¯•æ–¹æ¡ˆ1 (é™¤éæ˜ç¡®æŒ‡å®šå…¶ä»–ç­–ç•¥)
          if [ "$STRATEGY" = "auto" ] || [ "$STRATEGY" = "method1" ] || [ "$STRATEGY" = "test-both" ]; then
            echo "ğŸ“¦ æµ‹è¯•æ–¹æ¡ˆ1: è‡ªå®šä¹‰Pythonç›®å½•"
            if docker build -f Dockerfile-multistage-perfect -t test-ms1:latest . ; then
              echo "âœ… æ–¹æ¡ˆ1æ„å»ºæˆåŠŸ"
              
              # æµ‹è¯•Flaskå¯¼å…¥
              if docker run --rm test-ms1:latest python -c "import flask; print('Flask version:', flask.__version__)"; then
                echo "âœ… æ–¹æ¡ˆ1 Flaskå¯¼å…¥æˆåŠŸ"
                METHOD1_OK=true
                METHOD1_SIZE=$(docker images test-ms1:latest --format "{{.Size}}")
                echo "ğŸ“Š æ–¹æ¡ˆ1é•œåƒå¤§å°: $METHOD1_SIZE"
              else
                echo "âŒ æ–¹æ¡ˆ1 Flaskå¯¼å…¥å¤±è´¥"
                METHOD1_OK=false
              fi
            else
              echo "âŒ æ–¹æ¡ˆ1æ„å»ºå¤±è´¥"
              METHOD1_OK=false
            fi
          else
            METHOD1_OK=false
          fi
          
          # æµ‹è¯•æ–¹æ¡ˆ2 (é™¤éæ˜ç¡®æŒ‡å®šmethod1)
          if [ "$STRATEGY" = "auto" ] || [ "$STRATEGY" = "method2" ] || [ "$STRATEGY" = "test-both" ]; then
            echo "ğŸ“¦ æµ‹è¯•æ–¹æ¡ˆ2: ç³»ç»Ÿçº§åŒ…å¤åˆ¶"
            if docker build -f Dockerfile-multistage-alt -t test-ms2:latest . ; then
              echo "âœ… æ–¹æ¡ˆ2æ„å»ºæˆåŠŸ"
              
              # æµ‹è¯•Flaskå¯¼å…¥
              if docker run --rm test-ms2:latest python -c "import flask; print('Flask version:', flask.__version__)"; then
                echo "âœ… æ–¹æ¡ˆ2 Flaskå¯¼å…¥æˆåŠŸ"
                METHOD2_OK=true
                METHOD2_SIZE=$(docker images test-ms2:latest --format "{{.Size}}")
                echo "ğŸ“Š æ–¹æ¡ˆ2é•œåƒå¤§å°: $METHOD2_SIZE"
              else
                echo "âŒ æ–¹æ¡ˆ2 Flaskå¯¼å…¥å¤±è´¥"
                METHOD2_OK=false
              fi
            else
              echo "âŒ æ–¹æ¡ˆ2æ„å»ºå¤±è´¥"
              METHOD2_OK=false
            fi
          else
            METHOD2_OK=false
          fi
          
          # é€‰æ‹©æœ€ä½³ç­–ç•¥
          if [ "$STRATEGY" = "method1" ] && [ "$METHOD1_OK" = "true" ]; then
            SUCCESS_METHOD="method1"
            BEST_SIZE="$METHOD1_SIZE"
            cp Dockerfile-multistage-perfect Dockerfile.final
          elif [ "$STRATEGY" = "method2" ] && [ "$METHOD2_OK" = "true" ]; then
            SUCCESS_METHOD="method2"
            BEST_SIZE="$METHOD2_SIZE"
            cp Dockerfile-multistage-alt Dockerfile.final
          elif [ "$METHOD2_OK" = "true" ]; then
            # ä¼˜å…ˆé€‰æ‹©æ–¹æ¡ˆ2 (æ›´å¯é )
            SUCCESS_METHOD="method2"
            BEST_SIZE="$METHOD2_SIZE"
            cp Dockerfile-multistage-alt Dockerfile.final
            echo "ğŸ† è‡ªåŠ¨é€‰æ‹©æ–¹æ¡ˆ2 (ç³»ç»Ÿçº§åŒ…å¤åˆ¶)"
          elif [ "$METHOD1_OK" = "true" ]; then
            SUCCESS_METHOD="method1"
            BEST_SIZE="$METHOD1_SIZE"
            cp Dockerfile-multistage-perfect Dockerfile.final
            echo "ğŸ† è‡ªåŠ¨é€‰æ‹©æ–¹æ¡ˆ1 (è‡ªå®šä¹‰Pythonç›®å½•)"
          else
            echo "âŒ æ‰€æœ‰å¤šé˜¶æ®µæ„å»ºæ–¹æ¡ˆéƒ½å¤±è´¥ï¼Œå›é€€åˆ°å•é˜¶æ®µæ„å»º"
            SUCCESS_METHOD="single-stage"
            BEST_SIZE="é¢„è®¡180MB"
            
            # åˆ›å»ºå•é˜¶æ®µæ„å»ºDockerfile - ä¿®å¤YAMLè¯­æ³•é”™è¯¯
            cat > Dockerfile.final << 'DOCKERFILE_END'
FROM python:3.11-alpine

WORKDIR /app
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV FLASK_APP=app.py
ENV FLASK_ENV=production

RUN apk add --no-cache curl gcc musl-dev linux-headers && \
    pip install --no-cache-dir --upgrade pip

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt && \
    apk del gcc musl-dev linux-headers

COPY app.py .
COPY templates/ templates/
COPY static/ static/

RUN mkdir -p logs config && \
    adduser -D -s /bin/sh app && \
    chown -R app:app /app

USER app
EXPOSE 5000

HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:5000/ || exit 1

CMD ["python", "app.py"]
DOCKERFILE_END
          fi
          
          echo "best_strategy=$SUCCESS_METHOD" >> $GITHUB_OUTPUT
          echo "final_size=$BEST_SIZE" >> $GITHUB_OUTPUT
          
          # æ¸…ç†æµ‹è¯•é•œåƒ
          docker rmi test-ms1:latest test-ms2:latest 2>/dev/null || true
      
      # æ›´æ–°VERSIONæ–‡ä»¶
      - name: ğŸ“ Update VERSION file
        if: github.event_name != 'pull_request' && steps.version.outputs.is_dev == 'false'
        run: |
          echo "${{ steps.version.outputs.version }}" > VERSION
          
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if git diff --quiet; then
            echo "VERSIONæ–‡ä»¶æ— å˜æ›´ï¼Œè·³è¿‡æäº¤"
          else
            git add VERSION
            git commit -m "chore: bump version to ${{ steps.version.outputs.version }} [skip ci]"
            echo "VERSIONæ–‡ä»¶å·²æ›´æ–°å¹¶æäº¤"
          fi
      
      # æ¨é€VERSIONæ–‡ä»¶æ›´æ–°
      - name: ğŸ”„ Push VERSION update
        if: github.event_name != 'pull_request' && steps.version.outputs.is_dev == 'false'
        run: |
          if git log origin/${{ github.ref_name }}..${{ github.ref_name }} --oneline | grep -q .; then
            echo "æ¨é€VERSIONæ–‡ä»¶æ›´æ–°..."
            git push origin ${{ github.ref_name }}
          else
            echo "æ— éœ€æ¨é€ï¼ŒVERSIONæ–‡ä»¶æ— å˜æ›´"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # å‡†å¤‡Docker metadata
      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.version.outputs.version }}
            type=raw,value=${{ steps.version.outputs.version }}-${{ steps.strategy-test.outputs.best_strategy }}
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' && steps.version.outputs.is_dev == 'false' }}
            type=raw,value=multistage,enable=${{ steps.strategy-test.outputs.best_strategy != 'single-stage' }}
            type=raw,value=dev,enable=${{ steps.version.outputs.is_dev == 'true' }}
          labels: |
            org.opencontainers.image.title=IPåœ°å€å®‰å…¨åˆ†æå·¥å…· (å¤šé˜¶æ®µæ„å»º)
            org.opencontainers.image.description=æ”¯æŒAbuseIPDB APIé›†æˆçš„IPåœ°å€æ‰¹é‡å®‰å…¨åˆ†æWebåº”ç”¨ï¼Œä½¿ç”¨${{ steps.strategy-test.outputs.best_strategy }}æ„å»ºç­–ç•¥
            org.opencontainers.image.version=${{ steps.version.outputs.version }}
            org.opencontainers.image.vendor=${{ github.repository_owner }}
            org.opencontainers.image.licenses=MIT
            build.strategy=${{ steps.strategy-test.outputs.best_strategy }}
            build.size=${{ steps.strategy-test.outputs.final_size }}
      
      # æœ€ç»ˆæ„å»ºå’Œæ¨é€
      - name: ğŸ”¨ Final Build and Push
        id: final-build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.final
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' && (github.event.inputs.push_to_registry == 'true' || github.event.inputs.push_to_registry == '') }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
      
      # æ„å»ºç»“æœéªŒè¯
      - name: ğŸ” Build Verification
        if: github.event_name != 'pull_request'
        run: |
          echo "ğŸ¯ æ„å»ºéªŒè¯å¼€å§‹..."
          
          # æµ‹è¯•é•œåƒFlaskå¯¼å…¥
          echo "ğŸ§ª æµ‹è¯•æœ€ç»ˆé•œåƒFlaskæ¨¡å—..."
          if docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} python -c "import flask; print('âœ… æœ€ç»ˆé•œåƒFlaskéªŒè¯æˆåŠŸ:', flask.__version__)"; then
            echo "âœ… æœ€ç»ˆé•œåƒFlaskéªŒè¯é€šè¿‡"
          else
            echo "âŒ æœ€ç»ˆé•œåƒFlaskéªŒè¯å¤±è´¥"
            exit 1
          fi
          
          # è·å–æœ€ç»ˆé•œåƒå¤§å°
          FINAL_IMAGE_SIZE=$(docker images ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} --format "{{.Size}}" 2>/dev/null || echo "æœªçŸ¥")
          echo "ğŸ“Š æœ€ç»ˆé•œåƒå®é™…å¤§å°: $FINAL_IMAGE_SIZE"
      
      # è¾“å‡ºæ„å»ºä¿¡æ¯
      - name: ğŸ“Š Build Summary
        run: |
          echo "## ğŸ‹ å¤šé˜¶æ®µDockeræ„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ„å»ºç­–ç•¥:** \`${{ steps.strategy-test.outputs.best_strategy }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**é•œåƒç‰ˆæœ¬:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**é¢„ä¼°å¤§å°:** \`${{ steps.strategy-test.outputs.final_size }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**é•œåƒæ ‡ç­¾:**" >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.meta.outputs.tags }}' | sed 's/^/- `/' | sed 's/$/`/' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ”¯æŒæ¶æ„:** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "**é•œåƒæ‘˜è¦:** \`${{ steps.final-build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**æ‹‰å–å‘½ä»¤:**" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.strategy-test.outputs.best_strategy }}" != "single-stage" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ‰ **å¤šé˜¶æ®µæ„å»ºæˆåŠŸï¼é•œåƒå¤§å°æ˜¾è‘—ä¼˜åŒ–ï¼**" >> $GITHUB_STEP_SUMMARY
            fi
          fi
      
      # å®‰å…¨æ‰«æ
      - name: ğŸ›¡ï¸ Run Trivy vulnerability scanner
        if: github.event_name != 'pull_request'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true
      
      # ä¸Šä¼ å®‰å…¨æ‰«æç»“æœ
      - name: ğŸ“¤ Upload Trivy scan results
        if: github.event_name != 'pull_request'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true
  
  # åˆ›å»ºGitHub Release
  create-release:
    if: github.event_name != 'pull_request' && needs.multistage-build.outputs.image-version != '' && !contains(needs.multistage-build.outputs.image-version, 'dev')
    needs: multistage-build
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ“‹ Generate changelog
        id: changelog
        run: |
          VERSION="${{ needs.multistage-build.outputs.image-version }}"
          STRATEGY="${{ needs.multistage-build.outputs.best-strategy }}"
          SIZE="${{ needs.multistage-build.outputs.final-size }}"
          
          STRATEGY_DESC=""
          case $STRATEGY in
            "method1") STRATEGY_DESC="è‡ªå®šä¹‰Pythonç›®å½•çš„å¤šé˜¶æ®µæ„å»º" ;;
            "method2") STRATEGY_DESC="ç³»ç»Ÿçº§åŒ…å¤åˆ¶çš„å¤šé˜¶æ®µæ„å»º" ;;
            "single-stage") STRATEGY_DESC="å•é˜¶æ®µæ„å»º (å¤šé˜¶æ®µæ„å»ºå›é€€)" ;;
            *) STRATEGY_DESC="ä¼˜åŒ–æ„å»ºç­–ç•¥" ;;
          esac
          
          CHANGELOG=$(cat << EOF
          ## ğŸš€ Version $VERSION
          
          ### ğŸ—ï¸ æ„å»ºä¿¡æ¯
          - **æ„å»ºç­–ç•¥:** $STRATEGY_DESC
          - **é•œåƒå¤§å°:** $SIZE
          - **æ”¯æŒæ¶æ„:** linux/amd64, linux/arm64
          - **é•œåƒæ‘˜è¦:** \`${{ needs.multistage-build.outputs.image-digest }}\`
          
          ### ğŸ“¦ Dockeré•œåƒ
          \`\`\`bash
          docker pull ghcr.io/${{ github.repository }}:$VERSION
          \`\`\`
          
          ### ğŸ³ Docker Compose
          \`\`\`yaml
          version: '3.8'
          services:
            ip-analyzer:
              image: ghcr.io/${{ github.repository }}:$VERSION
              ports:
                - "5000:5000"
              environment:
                - ABUSEIPDB_API_KEY=\${ABUSEIPDB_API_KEY}
              restart: unless-stopped
          \`\`\`
          
          ### ğŸ¯ ä¼˜åŒ–äº®ç‚¹
          EOF
          )
          
          if [ "$STRATEGY" != "single-stage" ]; then
            CHANGELOG="$CHANGELOG
          - âœ… å¤šé˜¶æ®µæ„å»ºæˆåŠŸï¼Œé•œåƒå¤§å°æ˜¾è‘—ä¼˜åŒ–
          - ğŸš€ æ›´å¿«çš„éƒ¨ç½²å’Œæ‹‰å–é€Ÿåº¦
          - ğŸ’¾ èŠ‚çœå­˜å‚¨ç©ºé—´å’Œå¸¦å®½"
          fi
          
          CHANGELOG="$CHANGELOG
          
          > ğŸ” å®Œæ•´çš„å˜æ›´å†…å®¹è¯·æŸ¥çœ‹æäº¤å†å²"
          
          {
            echo "changelog<<CHANGELOG_EOF"
            echo "$CHANGELOG"
            echo "CHANGELOG_EOF"
          } >> $GITHUB_OUTPUT
      
      - name: ğŸ·ï¸ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.multistage-build.outputs.image-version }}
          name: Release v${{ needs.multistage-build.outputs.image-version }} (${{ needs.multistage-build.outputs.best-strategy }})
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            VERSION
            README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  # é€šçŸ¥æ„å»ºç»“æœ
  notify:
    if: always()
    needs: [multistage-build, create-release]
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¢ Build Status
        run: |
          if [ "${{ needs.multistage-build.result }}" = "success" ]; then
            echo "âœ… å¤šé˜¶æ®µDockeré•œåƒæ„å»ºæˆåŠŸ!"
            echo "æ„å»ºç­–ç•¥: ${{ needs.multistage-build.outputs.best-strategy }}"
            echo "é•œåƒç‰ˆæœ¬: ${{ needs.multistage-build.outputs.image-version }}"
            echo "é•œåƒå¤§å°: ${{ needs.multistage-build.outputs.final-size }}"
            
            if [ "${{ needs.multistage-build.outputs.best-strategy }}" != "single-stage" ]; then
              echo ""
              echo "ğŸ‰ å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–æˆåŠŸ!"
              echo "ç›¸æ¯”å•é˜¶æ®µæ„å»ºï¼Œé•œåƒå¤§å°æ˜¾è‘—å‡å°‘!"
            fi
          else
            echo "âŒ å¤šé˜¶æ®µDockeré•œåƒæ„å»ºå¤±è´¥"
            exit 1
          fi