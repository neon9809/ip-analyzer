name: Docker Build and Push

# è§¦å‘æ¡ä»¶
on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬ç±»å‹'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - custom
      custom_version:
        description: 'è‡ªå®šä¹‰ç‰ˆæœ¬å· (ä»…å½“ç‰ˆæœ¬ç±»å‹ä¸ºcustomæ—¶)'
        required: false
        type: string
      push_to_registry:
        description: 'æ¨é€åˆ°å®¹å™¨ä»“åº“'
        required: true
        default: true
        type: boolean
  
  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è‡ªåŠ¨æ„å»º
  push:
    branches: [ "main" ]
    paths:
      - 'app.py'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'templates/**'
      - 'static/**'
  
  # Pull Requestæ—¶æ„å»ºæµ‹è¯•
  pull_request:
    branches: [ "main" ]
    paths:
      - 'app.py'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'templates/**'
      - 'static/**'

# ç¯å¢ƒå˜é‡
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    # è¿™å°±æ˜¯å…¨éƒ¨éœ€è¦çš„æƒé™é…ç½®
    permissions:
      contents: write      # æ¨é€VERSIONæ–‡ä»¶
      packages: write      # æ¨é€Dockeré•œåƒåˆ°ghcr.io
      id-token: write      # OIDCè®¤è¯ï¼ˆå¯é€‰ï¼‰
      security-events: write # ä¸Šä¼ å®‰å…¨æ‰«æç»“æœï¼ˆå¯é€‰ï¼‰
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨è‡ªåŠ¨æä¾›çš„token

      
      # è®¾ç½®Docker Buildx
      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64
      
      # ç™»å½•åˆ°GitHub Container Registry
      - name: ğŸ”‘ Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      # è®¡ç®—ç‰ˆæœ¬å·
      - name: ğŸ“‹ Calculate version
        id: version
        run: |
          set -e
          
          # è·å–å½“å‰ç‰ˆæœ¬
          if [ -f VERSION ]; then
            CURRENT_VERSION=$(cat VERSION)
          else
            CURRENT_VERSION="1.0.0"
          fi
          
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
          
          # è§£æç‰ˆæœ¬å·
          IFS='.' read -ra PARTS <<< "$CURRENT_VERSION"
          MAJOR=${PARTS[0]}
          MINOR=${PARTS[1]}
          PATCH=${PARTS[2]}
          
          # æ ¹æ®è§¦å‘æ–¹å¼ç¡®å®šç‰ˆæœ¬ç±»å‹
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION_TYPE="${{ github.event.inputs.version_type }}"
            CUSTOM_VERSION="${{ github.event.inputs.custom_version }}"
          elif [ "${{ github.event_name }}" = "push" ]; then
            VERSION_TYPE="patch"
          else
            # Pull Request - ä½¿ç”¨å¼€å‘ç‰ˆæœ¬
            VERSION_TYPE="dev"
          fi
          
          echo "ç‰ˆæœ¬ç±»å‹: $VERSION_TYPE"
          
          # è®¡ç®—æ–°ç‰ˆæœ¬
          case $VERSION_TYPE in
            "major")
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
              ;;
            "minor")
              MINOR=$((MINOR + 1))
              PATCH=0
              NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
              ;;
            "patch")
              PATCH=$((PATCH + 1))
              NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
              ;;
            "custom")
              if [ -n "$CUSTOM_VERSION" ]; then
                NEW_VERSION="$CUSTOM_VERSION"
              else
                echo "é”™è¯¯: è‡ªå®šä¹‰ç‰ˆæœ¬ç±»å‹éœ€è¦æä¾›ç‰ˆæœ¬å·"
                exit 1
              fi
              ;;
            "dev")
              # PRæ„å»ºä½¿ç”¨å¼€å‘ç‰ˆæœ¬
              SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
              NEW_VERSION="${CURRENT_VERSION}-dev.${SHORT_SHA}"
              ;;
            *)
              echo "é”™è¯¯: æ— æ•ˆçš„ç‰ˆæœ¬ç±»å‹"
              exit 1
              ;;
          esac
          
          echo "æ–°ç‰ˆæœ¬: $NEW_VERSION"
          
          # è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          echo "patch=$PATCH" >> $GITHUB_OUTPUT
          echo "is_dev=$( [ "$VERSION_TYPE" = "dev" ] && echo "true" || echo "false" )" >> $GITHUB_OUTPUT
      
      # æ›´æ–°VERSIONæ–‡ä»¶ - ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼
      - name: ğŸ“ Update VERSION file
        if: github.event_name != 'pull_request' && steps.version.outputs.is_dev == 'false'
        run: |
          echo "${{ steps.version.outputs.version }}" > VERSION
          
          # é…ç½®Gitç”¨æˆ·
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet; then
            echo "VERSIONæ–‡ä»¶æ— å˜æ›´ï¼Œè·³è¿‡æäº¤"
          else
            git add VERSION
            git commit -m "chore: bump version to ${{ steps.version.outputs.version }} [skip ci]"
            echo "VERSIONæ–‡ä»¶å·²æ›´æ–°å¹¶æäº¤"
          fi
      
      # æ¨é€VERSIONæ–‡ä»¶æ›´æ–° - ä½¿ç”¨å®˜æ–¹Actions
      - name: ğŸ”„ Push VERSION update
        if: github.event_name != 'pull_request' && steps.version.outputs.is_dev == 'false'
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å¾…æ¨é€çš„æäº¤
          if git log origin/${{ github.ref_name }}..${{ github.ref_name }} --oneline | grep -q .; then
            echo "æ¨é€VERSIONæ–‡ä»¶æ›´æ–°..."
            git push origin ${{ github.ref_name }}
          else
            echo "æ— éœ€æ¨é€ï¼ŒVERSIONæ–‡ä»¶æ— å˜æ›´"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # å‡†å¤‡Docker metadata
      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾
            type=raw,value=${{ steps.version.outputs.version }}
            type=raw,value=${{ steps.version.outputs.major }}.${{ steps.version.outputs.minor }},enable=${{ steps.version.outputs.is_dev == 'false' }}
            type=raw,value=${{ steps.version.outputs.major }},enable=${{ steps.version.outputs.is_dev == 'false' }}
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' && steps.version.outputs.is_dev == 'false' }}
            # å¼€å‘ç‰ˆæœ¬æ ‡ç­¾
            type=raw,value=dev,enable=${{ steps.version.outputs.is_dev == 'true' }}
          labels: |
            org.opencontainers.image.title=IPåœ°å€å®‰å…¨åˆ†æå·¥å…·
            org.opencontainers.image.description=æ”¯æŒAbuseIPDB APIé›†æˆçš„IPåœ°å€æ‰¹é‡å®‰å…¨åˆ†æWebåº”ç”¨
            org.opencontainers.image.version=${{ steps.version.outputs.version }}
            org.opencontainers.image.vendor=${{ github.repository_owner }}
            org.opencontainers.image.licenses=MIT
      
      # æ„å»ºå’Œæ¨é€Dockeré•œåƒ
      - name: ğŸ”¨ Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' && (github.event.inputs.push_to_registry == 'true' || github.event.inputs.push_to_registry == '') }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
      
      # è¾“å‡ºæ„å»ºä¿¡æ¯
      - name: ğŸ“Š Build Summary
        run: |
          echo "## ğŸ‹ Dockeræ„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**é•œåƒç‰ˆæœ¬:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**é•œåƒæ ‡ç­¾:**" >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.meta.outputs.tags }}' | sed 's/^/- `/' | sed 's/$/`/' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ”¯æŒæ¶æ„:** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "**é•œåƒæ‘˜è¦:** \`${{ steps.build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**æ‹‰å–å‘½ä»¤:**" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      # å®‰å…¨æ‰«æ
      - name: ğŸ›¡ï¸ Run Trivy vulnerability scanner
        if: github.event_name != 'pull_request'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true  # å…è®¸æ‰«æå¤±è´¥ç»§ç»­æ‰§è¡Œ
      
      # ä¸Šä¼ å®‰å…¨æ‰«æç»“æœ
      - name: ğŸ“¤ Upload Trivy scan results
        if: github.event_name != 'pull_request'
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true  # å…è®¸ä¸Šä¼ å¤±è´¥ç»§ç»­æ‰§è¡Œ
  
  # åˆ›å»ºGitHub Releaseï¼ˆä»…é™æ­£å¼ç‰ˆæœ¬ï¼‰
  create-release:
    if: github.event_name != 'pull_request' && needs.build-and-push.outputs.image-version != '' && !contains(needs.build-and-push.outputs.image-version, 'dev')
    needs: build-and-push
    runs-on: ubuntu-latest
    
    permissions:
      contents: write    # åˆ›å»ºReleaseéœ€è¦å†™æƒé™
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ“‹ Generate changelog
        id: changelog
        run: |
          VERSION="${{ needs.build-and-push.outputs.image-version }}"
          
          # ç”Ÿæˆå˜æ›´æ—¥å¿—
          CHANGELOG=$(cat << EOF
          ## ğŸš€ Version $VERSION
          
          ### ğŸ“¦ Dockeré•œåƒ
          - **é•œåƒæ ‡ç­¾:** \`ghcr.io/${{ github.repository }}:$VERSION\`
          - **æ”¯æŒæ¶æ„:** linux/amd64, linux/arm64
          - **é•œåƒæ‘˜è¦:** \`${{ needs.build-and-push.outputs.image-digest }}\`
          
          ### ğŸ”§ æ‹‰å–å‘½ä»¤
          \`\`\`bash
          docker pull ghcr.io/${{ github.repository }}:$VERSION
          \`\`\`
          
          ### ğŸ³ Docker Compose
          \`\`\`yaml
          version: '3.8'
          services:
            ip-analyzer:
              image: ghcr.io/${{ github.repository }}:$VERSION
              ports:
                - "5000:5000"
              environment:
                - ABUSEIPDB_API_KEY=\${ABUSEIPDB_API_KEY}
          \`\`\`
          
          > ğŸ” å®Œæ•´çš„å˜æ›´å†…å®¹è¯·æŸ¥çœ‹æäº¤å†å²
          EOF
          )
          
          # ä¿å­˜åˆ°æ–‡ä»¶
          echo "$CHANGELOG" > release_notes.md
          
          # è®¾ç½®è¾“å‡º - ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼
          {
            echo "changelog<<CHANGELOG_EOF"
            echo "$CHANGELOG"
            echo "CHANGELOG_EOF"
          } >> $GITHUB_OUTPUT
      
      - name: ğŸ·ï¸ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.build-and-push.outputs.image-version }}
          name: Release v${{ needs.build-and-push.outputs.image-version }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            VERSION
            README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  # é€šçŸ¥æ„å»ºç»“æœ
  notify:
    if: always()
    needs: [build-and-push, create-release]
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¢ Build Status
        run: |
          if [ "${{ needs.build-and-push.result }}" = "success" ]; then
            echo "âœ… Dockeré•œåƒæ„å»ºæˆåŠŸ"
            echo "ç‰ˆæœ¬: ${{ needs.build-and-push.outputs.image-version }}"
          else
            echo "âŒ Dockeré•œåƒæ„å»ºå¤±è´¥"
            exit 1
          fi
